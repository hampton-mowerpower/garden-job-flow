import React from 'react';
import { Button } from '@/components/ui/button';
import { Printer } from 'lucide-react';
import { Job } from '@/types/job';
import { formatCurrency } from '@/lib/calculations';
import { format } from 'date-fns';
import hamptonLogo from '@/assets/hampton-logo.png';

interface JobPrintInvoiceProps {
  job: Job;
}

// Service checklist data
const SERVICE_CHECKLISTS = {
  universal: ['Engine compression test', 'Adjust carb/tune (idle/high)', 'Flush/replace stale fuel; clean tank', 'Charge/test battery (where fitted)', 'Verify operating performance under load', 'Inspect all electrical wiring/connectors', 'Check oil level/quality; inspect for leaks', 'Inspect/clean/replace air filter', 'Inspect/replace spark plug; gap check', 'Check coil/ignition output', 'Check/adjust governor spring/linkage', 'Inspect throttle cable & return spring', 'Inspect brake/stop switch operation', 'Check belt condition/tension (if fitted)', 'Grease gearbox/shaft points (if fitted)', 'Inspect fasteners/mounts for vibration', 'Test safety features (stops/guards)', 'Document recommendations/parts required'],
  'lawn-mower': ['Blade condition & balance; secure blade carrier', 'Deck clean; chute & catcher fitment', 'Height adjuster operation', 'Wheel/tyre/bearings; handle locks and cables'],
  'ride-on-mower': ['Deck spindle/bearing noise; blade set & torque', 'Deck level/cut height calibration', 'PTO clutch engagement/disengagement', 'Hydrostatic drive performance; leaks', 'Steering/controls neutral & tracking', 'Battery/charging system (stator/rectifier)', 'Seat switch & all safety interlocks', 'Tyre pressures; wheel nuts; tow hitch'],
  'line-trimmer': ['Head/line feed; guard condition', 'Shaft/gearbox grease; anti-vibe mounts', 'Trigger/throttle cable smoothness'],
  'chainsaw': ['Chain sharpness, depth gauges; bar wear', 'Chain tension; oiler flow & oil pump drive', 'Chain brake function; clutch/sprocket condition', 'AV mounts; choke/primer operation'],
  'blower': ['Impeller/fan housing clearance & damage', 'Cruise control/trigger; vac bag/zip condition']
};

export const JobPrintInvoice: React.FC<JobPrintInvoiceProps> = ({ job }) => {
  const handlePrintInvoice = () => {
    const escapeHtml = (unsafe: string): string => unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
    
    const isAccountCustomer = job.customer.notes?.toLowerCase().includes('account') || false;
    const issueDate = job.createdAt || new Date();
    const dueDate = isAccountCustomer ? new Date(issueDate.getTime() + 30 * 24 * 60 * 60 * 1000) : issueDate;
    const paymentTerms = isAccountCustomer ? 'Net 30 Days (Account)' : 'Paid on Collection';
    const paymentBadge = isAccountCustomer ? 'PAYMENT DUE: 30 DAYS (ACCOUNT)' : 'PAYMENT DUE: ON COLLECTION';
    const balanceDue = Math.max(0, job.grandTotal - (job.serviceDeposit || 0));
    const categoryKey = job.machineCategory?.toLowerCase().replace(/\s+/g, '-') || '';
    const relevantChecklist = SERVICE_CHECKLISTS[categoryKey as keyof typeof SERVICE_CHECKLISTS] || [];

    const invoiceHTML = `<!DOCTYPE html><html><head><meta charset="utf-8"><title>Invoice ${escapeHtml(job.jobNumber)} - Hampton Mowerpower</title><style>@page{size:A4;margin:12mm 18mm}*{margin:0;padding:0;box-sizing:border-box}body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;font-size:10pt;line-height:1.4;color:#1a1a1a}.invoice-header{display:flex;justify-content:space-between;margin-bottom:20px;padding-bottom:15px;border-bottom:3px solid #2563eb}.logo{max-width:180px;height:auto;margin-bottom:10px}.company-details{font-size:8pt;color:#666}.invoice-title{background:#2563eb;color:white;padding:8px 20px;font-size:24pt;font-weight:bold;margin-bottom:15px;display:inline-block}.invoice-info{font-size:9pt;line-height:1.6}.info-panels{display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:20px}.panel{border:1px solid #e5e7eb;padding:12px;background:#f9fafb}.panel-title{font-weight:bold;font-size:11pt;margin-bottom:8px;color:#2563eb;border-bottom:2px solid #2563eb;padding-bottom:4px}.panel-content{font-size:9pt;line-height:1.6}.equipment-section{margin-bottom:20px;border:1px solid #e5e7eb;padding:12px;background:#fffbeb}.concern-section{margin-bottom:20px;border:1px solid #e5e7eb;padding:12px;background:#fef2f2}.concern-section .panel-title{color:#dc2626;border-bottom-color:#dc2626}.checklist-section{margin-bottom:20px;border:1px solid #e5e7eb;padding:12px;background:#f0fdf4}.checklist-section .panel-title{color:#16a34a;border-bottom-color:#16a34a}.checklist-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:6px;margin-top:8px}.checklist-item{font-size:8pt;padding:4px;background:white;border:1px solid #d1d5db}.checklist-item::before{content:'‚òê';margin-right:6px;color:#16a34a}.parts-table{width:100%;border-collapse:collapse;margin-bottom:20px;font-size:9pt}.parts-table thead{background:#1e40af;color:white}.parts-table th{padding:10px 8px;text-align:left;font-weight:600}.parts-table td{padding:8px;border-bottom:1px solid #e5e7eb}.text-right{text-align:right}.text-center{text-align:center}.totals-section{display:flex;justify-content:flex-end;margin-bottom:20px}.totals-card{min-width:350px;border:2px solid #2563eb;background:#eff6ff}.totals-row{display:flex;justify-content:space-between;padding:8px 15px;border-bottom:1px solid #bfdbfe;font-size:10pt}.totals-row.total{background:#2563eb;color:white;font-weight:bold;font-size:12pt}.totals-row.deposit{background:#fef3c7;color:#92400e;font-weight:600}.totals-row.balance{background:#16a34a;color:white;font-weight:bold;font-size:12pt}.payment-badge{background:#dc2626;color:white;padding:8px 15px;text-align:center;font-weight:bold}.terms-section{margin-bottom:20px;padding:12px;border:1px solid #e5e7eb;background:#f9fafb;font-size:8pt}.invoice-footer{margin-top:30px;padding-top:15px;border-top:2px solid #e5e7eb;display:grid;grid-template-columns:1fr 1fr;gap:20px;font-size:8pt}.thank-you{text-align:center;margin-top:10px;font-size:9pt;font-style:italic;color:#2563eb}@media print{body{print-color-adjust:exact;-webkit-print-color-adjust:exact}}</style></head><body><div class="invoice-container"><div class="invoice-header"><div class="header-left"><img src="${hamptonLogo}" alt="Hampton Mowerpower" class="logo"/><div class="company-details"><strong>Hampton Mowerpower</strong> ¬∑ ABN 97 161 289 069<br>87 Ludstone Street, Hampton, VIC 3188, Australia<br>üìß hamptonmowerpower@gmail.com ¬∑ ‚òé 03-9598-6741</div></div><div class="header-right"><div class="invoice-title">INVOICE</div><div class="invoice-info"><div><strong>Invoice #:</strong> ${escapeHtml(job.jobNumber)}</div><div><strong>Issue Date:</strong> ${format(issueDate, 'dd MMM yyyy')}</div><div><strong>Due Date:</strong> ${format(dueDate, 'dd MMM yyyy')}</div></div></div></div><div class="info-panels"><div class="panel"><div class="panel-title">BILL TO</div><div class="panel-content"><p><strong>${escapeHtml(job.customer.name)}</strong></p><p>‚òé ${escapeHtml(job.customer.phone)}</p><p>${escapeHtml(job.customer.address)}</p></div></div><div class="panel"><div class="panel-title">JOB SUMMARY</div><div class="panel-content"><p><strong>Status:</strong> ${job.status.toUpperCase()}</p><p><strong>Created:</strong> ${format(job.createdAt, 'dd MMM yyyy')}</p></div></div></div><div class="equipment-section"><div class="panel-title">EQUIPMENT DETAILS</div><div class="panel-content"><p><strong>Category:</strong> ${escapeHtml(job.machineCategory)}</p><p><strong>Brand:</strong> ${escapeHtml(job.machineBrand)}</p><p><strong>Model:</strong> ${escapeHtml(job.machineModel)}</p></div></div>${job.problemDescription ? `<div class="concern-section"><div class="panel-title">CUSTOMER CONCERN</div><div class="panel-content"><p>${escapeHtml(job.problemDescription)}</p>${job.servicePerformed ? `<p style="margin-top:10px;"><strong>Findings:</strong> ${escapeHtml(job.servicePerformed)}</p>` : ''}</div></div>` : ''}${relevantChecklist.length > 0 ? `<div class="checklist-section"><div class="panel-title">SERVICE CHECKLIST</div><div class="checklist-grid">${SERVICE_CHECKLISTS.universal.map(item => `<div class="checklist-item">${escapeHtml(item)}</div>`).join('')}${relevantChecklist.map(item => `<div class="checklist-item">${escapeHtml(item)}</div>`).join('')}</div></div>` : ''}<table class="parts-table"><thead><tr><th>Description</th><th class="text-center">Qty</th><th class="text-right">Unit Price</th><th class="text-right">Total</th></tr></thead><tbody>${job.parts.map(part => `<tr><td>${escapeHtml(part.partName)}</td><td class="text-center">${part.quantity}</td><td class="text-right">${formatCurrency(part.unitPrice)}</td><td class="text-right">${formatCurrency(part.totalPrice)}</td></tr>`).join('')}${job.labourHours > 0 ? `<tr><td>Labour (${job.labourHours}h)</td><td class="text-center">1</td><td class="text-right">${formatCurrency(job.labourTotal)}</td><td class="text-right">${formatCurrency(job.labourTotal)}</td></tr>` : ''}</tbody></table><div class="totals-section"><div class="totals-card"><div class="totals-row"><span>Subtotal:</span><span>${formatCurrency(job.subtotal)}</span></div><div class="totals-row"><span>GST (10%):</span><span>${formatCurrency(job.gst)}</span></div><div class="totals-row total"><span>TOTAL:</span><span>${formatCurrency(job.grandTotal)}</span></div>${job.serviceDeposit > 0 ? `<div class="totals-row deposit"><span>Less: Deposit:</span><span>-${formatCurrency(job.serviceDeposit)}</span></div><div class="totals-row balance"><span>BALANCE DUE:</span><span>${formatCurrency(balanceDue)}</span></div>` : ''}<div class="payment-badge">${paymentBadge}</div></div></div><div class="terms-section"><h3>Payment Terms</h3><p>${paymentTerms}. Please reference Invoice #${escapeHtml(job.jobNumber)} with payment.</p></div><div class="invoice-footer"><div><h4>Hampton Mowerpower</h4><p>ABN 97 161 289 069<br>87 Ludstone Street, Hampton VIC 3188</p></div><div><h4>Contact</h4><p>üìß hamptonmowerpower@gmail.com<br>‚òé 03-9598-6741</p></div></div><div class="thank-you">Thank you for your business!</div></div></body></html>`;

    const printWindow = window.open('', '_blank');
    if (printWindow) {
      printWindow.document.write(invoiceHTML);
      printWindow.document.close();
      printWindow.onload = () => setTimeout(() => printWindow.print(), 250);
    }
  };

  return (
    <Button onClick={handlePrintInvoice} variant="default" size="sm">
      <Printer className="h-4 w-4 mr-2" />
      Print Invoice
    </Button>
  );
};
